rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if user follows target
    function isFollowing(userId, targetId) {
      return exists(/databases/$(database)/documents/following/$(userId)/users/$(targetId));
    }

    // Activities: owner write, visibility-based read
    match /activities/{activityId} {
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      allow read: if resource.data.visibility == "everyone"
                  || (request.auth != null
                      && (resource.data.userId == request.auth.uid
                          || (resource.data.visibility == "friends"
                              && isFollowing(request.auth.uid, resource.data.userId))));
      allow update, delete: if request.auth != null
                            && request.auth.uid == resource.data.userId;
    }

    // Activity Photos
    match /activity_photos/{activityId}/{photoId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Feed: owner read only (written by Cloud Functions)
    match /feed/{userId}/{activityId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }

    // Kudos (subcollection of activities)
    match /activities/{activityId}/kudos/{userId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Comments (subcollection of activities)
    match /activities/{activityId}/comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.userId
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['text']);
      allow delete: if request.auth != null
                    && request.auth.uid == resource.data.userId;
    }

    // Notifications: owner read/update only (subcollection: notifications/{userId}/items/{notifId})
    match /notifications/{userId}/items/{notifId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // Segments: public read, auth create, owner/admin update
    match /segments/{segmentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.creatorId;
    }

    // Segment Efforts: public read (leaderboard), owner create
    match /segment_efforts/{segmentId}/efforts/{effortId} {
      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
    }

    // User PRs: owner only
    match /user_prs/{userId}/segments/{segmentId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Following (subcollection: following/{userId}/users/{targetId})
    match /following/{userId}/users/{targetId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Followers (subcollection: followers/{targetId}/users/{userId}, written by Cloud Functions)
    match /followers/{targetId}/users/{userId} {
      allow read: if request.auth != null;
    }

    // Group Rides (written by Cloud Functions)
    match /group_rides/{groupRideId} {
      allow read: if request.auth != null;
    }

    // User profiles (created by Cloud Functions, owner can update limited fields)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['defaultVisibility', 'nickname']);
      allow create, delete: if false;
    }

    // Strava tokens (server-only, no client access)
    match /users/{userId}/strava_tokens/{tokenId} {
      allow read, write: if false;
    }

    // Activity streams cache (written by Cloud Functions or client)
    match /activity_streams/{streamId} {
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if false;
    }
  }
}
