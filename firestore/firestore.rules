rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper: check if users are friends (양방향)
    function isFriend(userId, targetId) {
      return exists(/databases/$(database)/documents/friends/$(userId)/users/$(targetId));
    }

    // Legacy helper (하위 호환)
    function isFollowing(userId, targetId) {
      return exists(/databases/$(database)/documents/following/$(userId)/users/$(targetId));
    }

    // Activities: owner write, visibility-based read
    match /activities/{activityId} {
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      allow read: if resource.data.visibility == "everyone"
                  || (request.auth != null
                      && (resource.data.userId == request.auth.uid
                          || (resource.data.visibility == "friends"
                              && isFriend(request.auth.uid, resource.data.userId))));
      allow update, delete: if request.auth != null
                            && request.auth.uid == resource.data.userId;
    }

    // Activity Photos
    match /activity_photos/{activityId}/{photoId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow delete: if request.auth != null;
    }

    // Feed: owner read only (written by Cloud Functions)
    match /feed/{userId}/{activityId} {
      allow read: if request.auth != null && request.auth.uid == userId;
    }

    // Kudos (subcollection of activities)
    match /activities/{activityId}/kudos/{userId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Comments (subcollection of activities)
    match /activities/{activityId}/comments/{commentId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.userId
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['text']);
      allow delete: if request.auth != null
                    && request.auth.uid == resource.data.userId;
    }

    // Notifications: owner read/update only (subcollection: notifications/{userId}/items/{notifId})
    match /notifications/{userId}/items/{notifId} {
      allow read, update: if request.auth != null && request.auth.uid == userId;
    }

    // Segments: public read, auth create, owner/admin update
    match /segments/{segmentId} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.creatorId;
    }

    // Segment Efforts: public read (leaderboard), owner create
    match /segment_efforts/{segmentId}/efforts/{effortId} {
      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
    }

    // User PRs: owner only
    match /user_prs/{userId}/segments/{segmentId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Friends (양방향, CF가 역방향 자동 생성)
    match /friends/{userId}/users/{friendId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow delete: if request.auth != null
                     && (request.auth.uid == userId || request.auth.uid == friendId);
    }

    // Friend Requests
    match /friend_requests/{targetId}/items/{requesterId} {
      allow read: if request.auth != null
                   && (request.auth.uid == targetId || request.auth.uid == requesterId);
      allow create: if request.auth != null && request.auth.uid == requesterId;
      allow delete: if request.auth != null
                     && (request.auth.uid == targetId || request.auth.uid == requesterId);
    }

    // Following (legacy, 하위 호환)
    match /following/{userId}/users/{targetId} {
      allow read: if request.auth != null;
      allow create, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Followers (legacy, 하위 호환)
    match /followers/{targetId}/users/{userId} {
      allow read: if request.auth != null;
    }

    // Group Rides (written by Cloud Functions)
    match /group_rides/{groupRideId} {
      allow read: if request.auth != null;
    }

    // User profiles (created by Cloud Functions, owner can update limited fields)
    match /users/{userId} {
      allow read: if request.auth != null;
      allow update: if request.auth != null && request.auth.uid == userId
                    && request.resource.data.diff(resource.data).affectedKeys()
                       .hasOnly(['defaultVisibility', 'nickname', 'currentGroupId']);
      allow create: if request.auth != null && request.auth.uid == userId;
      allow delete: if false;
    }

    // Groups
    match /groups/{groupId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.creatorId;
      allow delete: if request.auth != null;

      // Group Members (subcollection)
      match /members/{memberId} {
        allow read: if request.auth != null;
        allow create: if request.auth != null;
        allow update: if request.auth != null
                      && request.auth.uid == memberId;
        allow delete: if request.auth != null;
      }
    }

    // Group Invitations
    match /group_invitations/{userId}/items/{groupId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow create: if request.auth != null;
      allow delete: if request.auth != null && request.auth.uid == userId;
    }

    // Analytics sampling
    match /analytics/sampling {
      allow read: if request.auth != null;
      allow write: if request.auth != null;

      match /users/{userId} {
        allow read, write: if request.auth != null;
      }
    }

    // Strava tokens (server-only, no client access)
    match /users/{userId}/strava_tokens/{tokenId} {
      allow read, write: if false;
    }

    // Activity streams cache (written by Cloud Functions or client)
    match /activity_streams/{streamId} {
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      allow update: if request.auth != null
                    && request.auth.uid == resource.data.userId;
      allow delete: if false;
    }

    // Route Sharing signaling (그룹 멤버 또는 direct 공유)
    match /route_sharing/{groupId}/{subcollection}/{docId} {
      allow read, write: if request.auth != null;
    }

    // Strava queue (server-only)
    match /strava_queue/{jobId} {
      allow read, write: if false;
    }

    // Strava rate limit (server-only)
    match /strava_rate_limit/{doc} {
      allow read, write: if false;
    }
  }
}
